<!doctype html>

<html lang="en">
<head>
    <title>Prosper Loan Analysis</title>
    <meta charset="utf-8">
    <script src="d3.min.js"></script>
    <script src="http://dimplejs.org/dist/dimple.v2.0.0.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/style.css">
    
    <script type="text/javascript">
      function create(data) {
      
      /*
        D3.js setup code
      */
        // Set the margins for use with the svgs
        var margin = {top: 20, right: 20, bottom: 30, left: 40},
            width = 1200 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;  
        
        var radius = 4,
            fillColor = "blue",
            multiplier = 1.75;
        
        var formatAsPercentage = d3.format("1%")
        
        // set up fill values for circles
        var cValue = function(d) { return d.OccGroup;},
            color = d3.scale.category10();
        
           
        
        // Modify the element with id="container", in this case a div
        d3.select("#container")
            .append("h1")
            .text("Borrower APR by Occupation and Income Level, using D3");
       
       // Create svg variable to use with D3 code 
        var svg = d3.select("#container")
            .append("svg")
                .attr("width", width + margin.top + margin.bottom)
                .attr("height", height + margin.left + margin.right)
        
        // Create myChart variable within the svg item to house the chart. 'g' is just an arbitrary containing child element in SVG
        // equivalent to 'div' in HTML
        var myChart = svg.append("g")
            .attr("transform","translate(" + margin.left +"," + margin.top +")");
        
      /*
        D3.js Chart construction code
      */
        
        //Constructing the axes - first find the extent of the data range for each axis
        var yScale = d3.scale.linear()
            .domain([0,d3.max(data, function(d){return d["BorrowerAPR"];})])
            .range([height,0])
            .nice();
                                
        // create the y-axis object (note - not added yet, just defined)
        var yAxis = d3.svg.axis()
            .scale(yScale)
            .tickSize(5)
            .tickFormat(formatAsPercentage)
            .orient("left"); // this specifies the orientation of labels to the axis
        
        // the x axis is categorical, so we need an ordinal scale. Check out padding if the data is too close to edges  
        var xScale = d3.scale.ordinal()
            .domain(["$1-25k", "$25-50k", "$50-75k", "$75-100k", "$100k+"])
            .rangePoints([0,width],1);
        
        // create the x-axis object (note - not added yet, just defined)
        var xAxis = d3.svg.axis()
            .scale(xScale)
            .tickSize(5)
            .orient("bottom");   // this specifies the orientation of labels to the axis   
        
        // Add the x-axis in it's own 'g' group.    
        myChart.append("g")
            .attr("transform","translate(0," + height + ")")
            .attr("class","x axis")
            .call(xAxis)
          .append('text')
            .attr("x", width)
            .attr("y", -6)
            .style("text-anchor","end")
            .text("Income Bracket");
        
        // Add the y-axis in it's own 'g' group.
        myChart.append("g")
                .attr("class","x axis")
            .call(yAxis)
          .append('text')
            .attr('transform', "rotate(-90)")
            .attr('y', 6)
            .attr('dy', ".71em")
            .style('text-anchor','end')
            .text('Average Borrower APR');
            
        // add the tooltip area to the webpage
        
        var tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);
    
     /*  
    // append circle for each item in the data - this code works!
      data.forEach(function(item) {
            myChart.append("circle")
              .attr("cx",xScale(item.IncomeRange))
              .attr("cy",yScale(item.BorrowerAPR))
              .attr("r",8)
              });
       */
            
       debugger;
        
        var circles = d3.select("svg").selectAll("circle")
                .data(data)
            .enter()
                .append('circle')
                    .attr("cx", function(d){
                                return xScale(d["IncomeRange"]) + margin.left;
                                })
                    .attr("cy", function(d){
                                return yScale(d["BorrowerAPR"]);
                                })
                    .attr("r", radius)
                    .style("fill", function(d) { return color(cValue(d));})
                    .on("mouseover", function(d) {
                         tooltip.transition()
                            .duration(200)
                            .style("opacity", .9);
                            tooltip.html(d.OccGroup)
                                .style("left", (d3.event.pageX + 5) + "px")
                                .style("top", (d3.event.pageY - 28) + "px");
                                })
                    .on("mouseout", function(d) {
                        tooltip.transition()
                            .duration(500)
                            .style("opacity", 0);
                                                 });
                    
                    
        /*
        // This code adds labels corretly, but I've commented it out as it's too crowded. Use tooltips instead
        var labels = d3.select("svg").selectAll('text')
                .data(data)
            .enter()
                .append("text")
                .attr("x", function(d){
                                return xScale(d["IncomeRange"]) + margin.left;
                                })
                .attr("y", function(d){
                                return yScale(d["BorrowerAPR"]);
                                })
                .text(function (d){
                                return d["OccGroup"];});    
         */
        
        /*
        // need to sort out this code - not working.
        var legend = d3.select("svg").append("g")
            .attr("class","legend")
            .attr("x",50)
            .attr("y",50)
            .attr("height",100)
            .attr("width", 100)
            .style("font-size","12px")
            .call(d3.legend);
        */
          debugger;
            
            
          d3.select("#container")
            .append("h1")
            .text("Borrower APR by Occupation and Income Level, using Dimple");
                      
        // Create svg variable to use with Dimple code  
        var svg2 = d3.select("#container")
            .append("svg")
              .attr("width", width + margin.top + margin.bottom)
              .attr("height", height + margin.left + margin.right)
            .append("g")
                .attr('class','chart');    
      /*
        Dimple.js Chart construction code
      */
        var myChart2 = new dimple.chart(svg2, data);
            
            var x = myChart2.addCategoryAxis("x", "IncomeRange");
            x.showGridlines = true;
            
            var y = myChart2.addMeasureAxis("y", "BorrowerAPR");
            y.showGridlines = true;
            y.tickFormat =".0%";
            
            myChart2.addSeries("OccGroup", dimple.plot.line);
            myChart2.addSeries("OccGroup", dimple.plot.scatter);
        
        myChart2.draw();   
             
        };
      </script>
</head>
<body>
    <div id="container">
        <h1>Udacity Data Analysis Nano Degree</h1>
        <h2>Project 6: Make Effective Data Visualization</h2>
        <h2>Author: Doug Wight</h2>
        <h3>Submission date: February 2016</h3>
    </div>
    
    <script type="text/javascript">
    /*
    Use D3 to load the CSV file
    and pass the contents of it to the create function
    */
    d3.csv("data/apr_data.csv", create);
    </script>
</body>
</html>
