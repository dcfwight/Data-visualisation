<!doctype html>

<html lang="en">
<head>
    <title>Prosper Loan Analysis</title>
    <meta charset="utf-8">
    <script src="d3.min.js"></script>
    <script src="http://dimplejs.org/dist/dimple.v2.0.0.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/style.css">
    
    <script type="text/javascript">
        
        // Set the margins for use with the svgs
        var margin = {top: 20, right: 20, bottom: 30, left: 40},
            legendBuffer = 150,
            width = 1200 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;  
        
        var radius = 4,
            fillColor = "blue",
            multiplier = 1.75;
        
        // Create percentageformat variable for use in axes
        var formatAsPercentage = d3.format("1%");
        
        // Create colors (52) for use with the 52 different occupations
        var colors = ["#8dd3c7","#ffffb3","#bebada","#fb8072","#80b1d3","#fdb462","#b3de69","#fccde5","#d9d9d9","#bc80bd","#ccebc5","#ffed6f",
                      "#66c2a5","#fc8d62","#8da0cb","#e78ac3","#a6d854","#ffd92f","#e5c494","#b3b3b3",
                      "#e41a1c","#377eb8","#4daf4a","#984ea3","#ff7f00","#ffff33","#a65628","#f781bf","#999999",
                      "#f7fcfd","#e5f5f9","#ccece6","#99d8c9","#66c2a4","#41ae76","#238b45","#006d2c","#00441b",
                      "#fff7fb","#ece2f0","#d0d1e6","#a6bddb","#67a9cf","#3690c0","#02818a","#016c59","#014636",
                      "#fff7fb","#ece7f2","#d0d1e6","#a6bddb","#74a9cf","#3690c0","#0570b0"];
        
        function draw(data) {
            d3.select("#container")
                .append("h1")
                .text("Borrower APR by Occupation and Income Level, using D3 - draw function");
        
            // Create svg variable to use with D3 code 
            var svg2 = d3.select("#container")
                .append("svg")
                    .attr("width", width + margin.top + margin.bottom)
                    .attr("height", height + margin.left + margin.right)
            
            // Create myChart variable within the svg item to house the chart. 'g' is just an arbitrary containing child element in SVG
            // equivalent to 'div' in HTML
            var myChart2 = svg2.append("g")
                .attr("transform","translate(" + margin.left +"," + margin.top +")")
                .attr("width", width);
                
            
                
            function plot_points(data) {
                
                // Extract the roll-up function from the nested function
                function agg_occupation(leaves) {
                    var meanApr = d3.mean(leaves, function(d){
                        return d['apr'];
                        });
                        
                        return {'meanAPR': meanApr,
                                'count':leaves.length};
                }
                
                // nest the data by Occupation Group then by Income Range
                var nested = d3.nest()
                    .key(function(d) {
                        return d['OccGroup'];
                    })
                    .key(function(d){
                        return d['income'];
                    })
                    .rollup(agg_occupation)
                    .entries(data);
                
                var occGroupScale2 = d3.scale.ordinal()
                    .domain(nested.keys)
                    .range(colors);
                
                // this function extracts the maximum meanAPR from a nested item - the lowest level
                // you then need to iterate over the nested[i].values
                function maxApr(nested_item) {
                    return d3.max(nested_item, function(d) {
                        return d.values.meanAPR;})
                }
                
                // this then returns the maximum of the maximum meanAPRs
                function maxAprGroup(double_nest) {
                    return d3.max(double_nest, function(d){
                        return maxApr(d.values);})
                }
                debugger;
                //Constructing the axes - first find the extent of the data range for each axis
                var yScale2 = d3.scale.linear()
                    .domain([0,maxAprGroup(nested)])
                    .range([height,0])
                    .nice();
                
                // create the y-axis object (note - not added yet, just defined)
                var yAxis2 = d3.svg.axis()
                    .scale(yScale2)
                    .tickSize(5)
                    .tickFormat(formatAsPercentage)
                    .orient("left") // this specifies the orientation of labels to the axis
                    .innerTickSize(legendBuffer-width);
                
                // the x axis is categorical, so we need an ordinal scale. Check out padding if the data is too close to edges  
                var xScale2 = d3.scale.ordinal()
                    .domain(["$1-25k", "$25-50k", "$50-75k", "$75-100k", "$100k+"])
                    .rangePoints([0,width - legendBuffer],1);
                
                // create the x-axis object (note - not added yet, just defined)
                var xAxis2 = d3.svg.axis()
                    .scale(xScale2)
                    .tickSize(5)
                    .orient("bottom");   // this specifies the orientation of labels to the axis
                    
                // Add the x-axis in it's own 'g' group.    
                myChart2.append("g")
                    .attr("transform","translate(0," + height + ")")
                    .attr("class","x axis")
                    .call(xAxis2)
                    .append('text')
                        .attr("x", width - legendBuffer)
                        .attr("y", -6)
                        .style("text-anchor","end")
                        .text("Income Bracket");
            
                // Add the y-axis in it's own 'g' group.
                myChart2.append("g")
                    .attr("class","y axis")
                    .call(yAxis2)
                    .append('text')
                        .attr('transform', "rotate(-90)")
                        .attr('y', 6)
                        .attr('dy', ".71em")
                        .style('text-anchor','end')
                        .style('fill','black')
                        .text('Average Borrower APR');
                      
            };// END of function create_full(data)
        
        plot_points(data);
        
        };
        
        function create(data) { 
            // Create a set of unique occupations called 'unique' by adding to it.
            var unique = d3.set();
            data.forEach(function(d){
                unique.add(d["OccGroup"])
                           });
            // Then create an array of the values in the set unique - makes code easier later on.
            var uniqueOcc = unique.values();
       
            // set up fill values for circles
            var cValue = function(d) { return d.OccGroup;};
        
            var occGroupScale = d3.scale.ordinal()
                .domain(uniqueOcc)
                .range(colors);
            
        
            // Modify the element with id="container", in this case a div
            d3.select("#container")
                .append("h1")
                .text("Borrower APR by Occupation and Income Level, using D3 - create function");
       
            // Create svg variable to use with D3 code 
            var svg = d3.select("#container")
                .append("svg")
                    .attr("width", width + margin.top + margin.bottom)
                    .attr("height", height + margin.left + margin.right)
            
            // Create myChart variable within the svg item to house the chart. 'g' is just an arbitrary containing child element in SVG
            // equivalent to 'div' in HTML
            var myChart = svg.append("g")
                .attr("transform","translate(" + margin.left +"," + margin.top +")")
                .attr("width", width);
          
            //Constructing the axes - first find the extent of the data range for each axis
            var yScale = d3.scale.linear()
                .domain([0,d3.max(data, function(d){
                    return d["BorrowerAPR"];
                    })])
                .range([height,0])
                .nice();
                                
            // create the y-axis object (note - not added yet, just defined)
            var yAxis = d3.svg.axis()
                .scale(yScale)
                .tickSize(5)
                .tickFormat(formatAsPercentage)
                .orient("left") // this specifies the orientation of labels to the axis
                .innerTickSize(legendBuffer-width);
        
            // the x axis is categorical, so we need an ordinal scale. Check out padding if the data is too close to edges  
            var xScale = d3.scale.ordinal()
                .domain(["$1-25k", "$25-50k", "$50-75k", "$75-100k", "$100k+"])
                .rangePoints([0,width - legendBuffer],1);
        
            // create the x-axis object (note - not added yet, just defined)
            var xAxis = d3.svg.axis()
                .scale(xScale)
                .tickSize(5)
                .orient("bottom");   // this specifies the orientation of labels to the axis   
        
            // Add the x-axis in it's own 'g' group.    
            myChart.append("g")
                .attr("transform","translate(0," + height + ")")
                .attr("class","x axis")
                .call(xAxis)
                .append('text')
                    .attr("x", width - legendBuffer)
                    .attr("y", -6)
                    .style("text-anchor","end")
                    .text("Income Bracket");
        
            // Add the y-axis in it's own 'g' group.
            myChart.append("g")
                .attr("class","y axis")
                .call(yAxis)
                .append('text')
                    .attr('transform', "rotate(-90)")
                    .attr('y', 6)
                    .attr('dy', ".71em")
                    .style('text-anchor','end')
                    .style('fill','black')
                    .text('Average Borrower APR');
            
            // add the tooltip area to the webpage
            var tooltip = d3.select("body")
                .append("div")
                    .attr("class", "tooltip")
                    .style("width", "150px")
                    .style("opacity", 0);
                
    
            /*  
            // append circle for each item in the data - this code works!
            data.forEach(function(item) {
                myChart.append("circle")
                    .attr("cx",xScale(item.IncomeRange))
                    .attr("cy",yScale(item.BorrowerAPR))
                    .attr("r",8)
            });
            */
            
           
               
            var circles = d3.select("svg").selectAll("circle")
                .data(data)
                    .enter()
                .append('circle')
                    .attr("cx", function(d){
                                return xScale(d["IncomeRange"]) + margin.left;
                                })
                    .attr("cy", function(d){
                                return yScale(d["BorrowerAPR"]);
                                })
                    .attr("r", radius)
                    .style("fill", function(d) { return occGroupScale(cValue(d));})
                    .on("mouseover", function(d) {
                        tooltip.transition()
                            .duration(200)
                            .style("opacity", .9);
                        tooltip.html(d.OccGroup + "<br>" + "Mean APR: " + d3.format(".1%")(d.BorrowerAPR))
                            .style("left", (d3.event.pageX + 5) + "px")
                            .style("top", (d3.event.pageY - 28) + "px")
                            .style("background-color","white");
                        })
                    .on("mouseout", function(d) {
                        tooltip.transition()
                            .duration(500)
                            .style("opacity", 0);
                                                 });
            
            // Create function to draw a line for an occupation group
            function lineDraw(occupation, occupData) {

                // Create function to define pixel points of the line
                var line = d3.svg.line()
                    .x(function(d) { return xScale(d.IncomeRange) + margin.left; })
                    .y(function(d) { return yScale(d.BorrowerAPR); });
            
                // Adding path along the points to create a line
                svg.append('path')
                    .datum(occupData)
                    .attr("class","line")
                    .attr("d",line)
                    .attr("stroke","green")
                    .attr("stroke",occGroupScale(occupation));
            }; // End of function lineDraw(occupation)
            
            // create function to filter the line to draw, by Occupation
            function update(occupation) {
                var filtered = data.filter(function(d){
                    return new Date(d['OccGroup']) === occupation;
                    });
            }
            debugger;
            
            // create simple function to return the key field we will use - makes sure we use
            // it consistently
            function key_func(d) {
                return d['OccGroup'];
            }
            
            // Create a loop to draw all the occupation lines
            for (occupation in uniqueOcc) { 
                var occupData = []
                for (datum in data) {
                    if (key_func(data[datum]) === uniqueOcc[occupation]) {
                    occupData.push(
                        {"IncomeRange":data[datum]["IncomeRange"],
                        "BorrowerAPR":data[datum]["BorrowerAPR"]}
                    );
                    }
                lineDraw(uniqueOcc[occupation], occupData);           
                };
            };
 
            // draw legend
            var container = d3.select("#container")
        
            var legend = svg.selectAll(".legend")
                .data(uniqueOcc)
                    .enter()
                .append("g")
                    .attr("class", "legend")
                    .attr("transform", function(d, i) { return "translate(0," + i * 8 +")"; });
                    
            // draw legend colored rectangles - note this could have been chained to the above
            legend.append("rect")
                .attr("class", "legendBox")
                .attr("x", width - 38)
                .attr("y", 2)
                .attr("width", 20)
                .attr("height", 6)
                .style("fill", function(d) {
                    return occGroupScale(d);
                    })
                
            
            // draw legend text
            legend.append("text")
                .attr("x", width - 16)
                .attr("y", 8)
                //.attr("dy", ".35em")
                .attr("font-size","8px")
                .style("text-anchor", "start")
                .text(function(d) {
                    return d;
                    });
            
          

                  
            /*
            // This code adds labels correctly, but I've commented it out as it's too crowded. Used tooltips instead
            var labels = d3.select("svg").selectAll('text')
                .data(data)
                    .enter()
                .append("text")
                .attr("x", function(d){
                                return xScale(d["IncomeRange"]) + margin.left;
                                })
                .attr("y", function(d){
                                return yScale(d["BorrowerAPR"]);
                                })
                .text(function (d){
                                return d["OccGroup"];});    
            */
        };   // End of the main function create(data).
        
        /*
         Create chart using Dimple
        */
        
        function createDimple(data) {
          d3.select("#container")
            .append("h1")
            .text("Borrower APR by Occupation and Income Level, using Dimple");
                      
        // Create svg variable to use with Dimple code  
        var svg3 = d3.select("#container")
            .append("svg")
              .attr("width", width + margin.top + margin.bottom)
              .attr("height", height + margin.left + margin.right)
            .append("g")
                .attr('class','chart');    

        var myChart3 = new dimple.chart(svg3, data);
            
            var x = myChart3.addCategoryAxis("x", "IncomeRange");
            x.showGridlines = true;
            
            var y = myChart3.addMeasureAxis("y", "BorrowerAPR");
            y.showGridlines = true;
            y.tickFormat =".0%";
            
            myChart3.addSeries("OccGroup", dimple.plot.line);
            myChart3.addSeries("OccGroup", dimple.plot.scatter);
        
        myChart3.draw();   
             
        };
      </script>
</head>
<body>
    <div id="container">
        <h1>Udacity Data Analysis Nano Degree</h1>
        <h2>Project 6: Make Effective Data Visualization</h2>
        <h2>Author: Doug Wight</h2>
        <h3>Submission date: February 2016</h3>
    </div>
    
    <script type="text/javascript">
    /*
    Use D3 to load the CSV file
    and pass the contents of it to the create function
    */
    d3.csv("data/loans_simple.csv", function(d) {
        return d;
        }, draw);
    d3.csv("data/apr_data.csv", create);
    d3.csv("data/apr_data.csv", createDimple);
    
    </script>
</body>
</html>
