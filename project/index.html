<!doctype html>

<html lang="en">
<head>
    <title>Prosper Loan Analysis</title>
    <meta charset="utf-8">
    <script src="d3.min.js"></script>
    <script src="http://dimplejs.org/dist/dimple.v2.0.0.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/style.css">
    
    <script type="text/javascript">
        
        // Set the margins for use with the svgs
        var margin = {top: 20, right: 20, bottom: 30, left: 40},
            legendBuffer = 150,
            width = 1200 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;  
        
        var radius = 4,
            fillColor = "blue",
            multiplier = 1.75;
            
        var buckets = ["$1-25k", "$25-50k", "$50-75k", "$75-100k", "$100k+"];
               
        // Create percentage format variable for use in axes
        var formatAsPercentage = d3.format("1%");
        
        // Create colors (52) for use with the 52 different occupations - might change
        var colors = ["#8dd3c7","#ffffb3","#bebada","#fb8072","#80b1d3","#fdb462","#b3de69","#fccde5","#d9d9d9","#bc80bd","#ccebc5","#ffed6f",
                      "#66c2a5","#fc8d62","#8da0cb","#e78ac3","#a6d854","#ffd92f","#e5c494","#b3b3b3",
                      "#e41a1c","#377eb8","#4daf4a","#984ea3","#ff7f00","#ffff33","#a65628","#f781bf","#c9d9d9",
                      "#b7fcfd","#d545f9","#ccece6","#99d8c9","#66c2a4","#41ae76","#238b45","#006d2c","#00441b",
                      "#fff7fb","#ece2f0","#d0d1e6","#a6bddb","#67a9cf","#3690c0","#02818a","#016c59","#014636",
                      "#fff7fb","#ece7f2","#d0d1e6","#a6bddb","#74a9cf","#3690c0","#0570b0"];
        
        var duration = 1000 // duration time for transitions
        
        function draw(data) {
            d3.select("#container") // this selects the div with id='container'
                .append("h1")
                .text("Borrower APR by Occupation and Income Level, using D3")
                .attr("class", "drawtitle");
        
            // Create svg variable to use with D3 code 
            var svg = d3.select("#container")
                .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .attr("class", "svg");
            
            // Create myChart variable within the svg item to house the chart. 'g' is just an arbitrary containing child element in SVG
            // equivalent to 'div' in HTML
            var myChart = svg.append("g")
                .attr("transform","translate(" + margin.left +"," + margin.top +")")
                .attr("width", width)
                .attr("class", "chart");
            
            // Create a set of unique occupations called 'occupations' by adding to it.
            var occupations = d3.set();
            data.forEach(function(d){
                occupations.add(d["OccGroup"])
                           });
            
            // then create an array of just the values in this set - makes the rest of the code much easier
            var uniqueOccupations = occupations.values();

            // the occupations are categorical, so we need an ordinal scale for the colors.
            var colorScale = d3.scale.ordinal()
                .domain(d3.extent(data, function(d){
                    return d.OccGroup;
                    }))
                .range(colors);
      
            // the x axis data is categorical, so we need an ordinal scale.
            // Change the padding if the data is too close to edges  
            var xScale = d3.scale.ordinal()
                .domain(["$1-25k", "$25-50k", "$50-75k", "$75-100k", "$100k+"])
                .rangePoints([0,width - legendBuffer],1);
                
            // create the x-axis object (note - not added yet, just defined the variable)
            var xAxis = d3.svg.axis()
                .scale(xScale)
                .tickSize(5)
                .orient("bottom");   // this specifies the orientation of labels relative to the axis   
                
            // Add the x-axis in it's own 'g' group.    
            myChart.append("g")
                    .attr("transform","translate(0," + height + ")")
                    .attr("class","x axis")
                    .call(xAxis)
                .append('text')
                    .attr("x", width - legendBuffer)
                    .attr("y", -6)
                    .style("text-anchor","end")
                    .text("Income Bracket");    
            
            // construct the y axis scale. This is linear as it is a range of apr values.
            var yScale = d3.scale.linear()
                .domain([0,d3.max(data, function(d){
                    return d.apr;
                    })])
                .range([height,0])
                .nice();
                
            // create the y-axis object (note - not added yet, just defined)
            var yAxis = d3.svg.axis()
                .scale(yScale)
                .tickSize(5)
                .tickFormat(formatAsPercentage)
                .orient("left") // this specifies the orientation of labels to the axis
                .innerTickSize(legendBuffer-width);
            
            // Add the y-axis in it's own 'g' group.
            myChart.append("g")
                    .attr("class","y axis")
                    .call(yAxis)
                .append('text')
                    .attr('transform', "rotate(-90)")
                    .attr('y',  6)
                    .attr('x', -4)
                    .attr('dy', ".71em")
                    .style('text-anchor','end')
                    .style('fill','black')
                    .text('Average Borrower APR');           
            // draw legend
            var legend = d3.select('.svg')
                .selectAll(".legend")
                .data(uniqueOccupations)
                    .enter()
                .append("g")
                    .attr("class", "legend")
                    .attr("transform", function(d, i) { return "translate(0," + i * 10 +")"; });
            
            // draw legend colored rectangles - note this could have been chained to the above
            legend.append("rect")
                .attr("class", "drawLegendBox")
                .attr("x", width - 58)
                .attr("y", 2)
                .attr("width", 34)
                .attr("height", 8)
                .style("fill", function(d) {
                    return colorScale(d );
                    });
            
            // draw legend text - again, could have chained this to the above
            legend.append("text")
                .attr("x", width - 16)
                .attr("y", 8)
                //.attr("dy", ".35em")
                .attr("font-size","10px")
                .style("text-anchor", "start")
                .text(function(d,i) {
                    return (i+1) + ":"+ d;
                    });
                
            // created a nested function, grouping the data by Occupation group.
            // not sure if I'm going to use it.
            var nested = d3.nest()
                .key(function(d){
                    return d.OccGroup;}
                    ).sortKeys(d3.ascending)
                .entries(data);
                
            // add the tooltip area to the div element with id 'container'
            var tooltip = d3.select("#container")
                .append("div")
                .attr("class", "tooltip")
                .style("width", "180px")
                .style('height',"40px")
                .style("opacity", 0);
            
            // define the key function we are going to be using to select circles and lines
            // common to both plot points and line draw, so it is in the draw function    
            function key_func(d) {
                return d['OccGroup'];
            }
            
            // create function to plot the circles - note, this is within the draw function    
            function plot_points(occupation_data) {
                
                // first count the number of data points.
                var n = occupation_data.length;
                // bind the data to the circles and enter them - using data, not nested.
                
                // tried using datum instead of data.enter()
                // removed .data(data).enter()
                var circles = svg.selectAll('circle')
                    .data(occupation_data)
                        .enter()
                    .append('circle')
                        .attr('cx', function(d){
                            return xScale(d.income) + margin.left;
                            })
                        .attr('cy', function(d){
                            return yScale(+d.apr);
                            })
                        .attr('r', radius)
                        .style('fill', function(d){
                            return colorScale(d.OccGroup);
                            })
                        .on("mouseover", function(d) {
                            tooltip.transition()
                            .duration(200)
                            .style("opacity", .9);
                            tooltip.html(d.OccGroup + "<br>"
                                         + "Income Group" + d.income + "<br>"
                                         + "Mean APR: " + d3.format(".1%")(d.apr))
                            .style('font-size',"10pt")
                            .style("left", (d3.event.pageX + 5) + "px")
                            .style("top", (d3.event.pageY - 28) + "px")
                            .style("background-color","white");
                            })
                        .on("mouseout", function(d) {
                            tooltip.transition()
                            .duration(500)
                            .style("opacity", 0);
                        });
                        debugger;
                        
                        /* this transition code works, but then it fouls up the tooltip - don't know why
                        .transition()
                                    .delay(function(d, i) { return (i / n) * duration; })
                                    .duration(duration)
                                    .style("opacity", 0.3)
                        */
                        
                        /*
                        // need to work on the circles code to work with the nested data        
                        var circles = d3.select(".svg")
                            .selectAll("circle")
                            .data(nested, function(d){
                                return d.values;})
                                .enter()
                            .append('circle')   
                                .attr('class','gCircle')
                                .attr('cx', function(d) {
                                        return xScale(d.income) + margin.left;
                                        })
                                .attr('cy', function(d) {
                                        return yScale(d.apr);
                                        })
                                .attr("r", radius)
                                
                                .style("opacity", 0.5);
                            debugger;
            
                        */
                         
            }// END of function plot points(data)    
            
            // Create function to draw a line for an occupation group
            function lineDraw(occupation, occupation_data) {
                // first unpack the data
                var occupLineData = []
                for (j in occupation_data) {
                    occupLineData.push(
                        {"income": occupation_data[j]["income"],
                        "apr": occupation_data[j]["apr"],
                        "OccGroup": occupation_data[j]["OccGroup"]}
                    ); 
                }
                
                // Create variable to define pixel points of the line
                var line = d3.svg.line()
                    .x(function(d) { return xScale(d.income) + margin.left; })
                    .y(function(d) { return yScale(d.apr); });
                
                // Adding path along the points to create a line
                svg.append('path')
                    .datum(occupLineData)
                    .attr("class","line")
                    .attr("d",line)
                    .attr("stroke","green")
                    .attr("stroke", colorScale(occupation))
                    .transition()
                    .duration(200);
            }; // End of function lineDraw(occupation)
                
            // define update function, to plot the data for a specific occupaiont
            function update(occupation) {
                // first filter the data to return only datapoints equal to that occupation
                subset = data.filter(function(d){
                    return d.OccGroup === occupation;
                    });
                
                debugger;
                
                var circles = svg.selectAll('circle')
                    .data(subset)
                
                //plot_points(subset); // pass those points to the plot_points function
                lineDraw(occupation, subset); // pass those points to the lineDraw function
            }
        
        // to loop through all occupations:
        occup_idx = 0
        
        var occupation_interval = setInterval(function(){
            update(uniqueOccupations[occup_idx]);
            occup_idx++;
            
            if (occup_idx >= uniqueOccupations.length) {
                clearInterval(occupation_interval);
            }
        }, 50);
        /*
        for (i in uniqueOccupations) {
            update(uniqueOccupations[i]);
            debugger;
        }
        */
        plot_points(data);
        
        };// END of function draw(data
        
        
      </script>
</head>
<body>
    <div id="container">
        <h1>Udacity Data Analysis Nano Degree</h1>
        <h2>Project 6: Make Effective Data Visualization</h2>
        <h2>Author: Doug Wight</h2>
        <h3>Submission date: February 2016</h3>
    </div>
    
    <script type="text/javascript">
    //Use D3 to load the CSV file and pass the contents of it to the draw function
    d3.csv("data/loans_clean.csv", draw);
    
    </script>
</body>
</html>
