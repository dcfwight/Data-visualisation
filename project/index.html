<!doctype html>

<html lang="en">
<head>
    <title>Prosper Loan Analysis</title>
    <meta charset="utf-8">
    <script src="d3.min.js"></script>
    <script src="http://dimplejs.org/dist/dimple.v2.0.0.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/style.css">
    
    <script type="text/javascript">
        
        // Set the margins for use with the svgs
        var margin = {top: 20, right: 20, bottom: 30, left: 40},
            legendBuffer = 150,
            width = 1200 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;  
        
        var radius = 4,
            fillColor = "blue",
            multiplier = 1.75;
        
        // Create percentage format variable for use in axes
        var formatAsPercentage = d3.format("1%");
        
        // Create colors (52) for use with the 52 different occupations - might change
        var colors = ["#8dd3c7","#ffffb3","#bebada","#fb8072","#80b1d3","#fdb462","#b3de69","#fccde5","#d9d9d9","#bc80bd","#ccebc5","#ffed6f",
                      "#66c2a5","#fc8d62","#8da0cb","#e78ac3","#a6d854","#ffd92f","#e5c494","#b3b3b3",
                      "#e41a1c","#377eb8","#4daf4a","#984ea3","#ff7f00","#ffff33","#a65628","#f781bf","#999999",
                      "#f7fcfd","#e5f5f9","#ccece6","#99d8c9","#66c2a4","#41ae76","#238b45","#006d2c","#00441b",
                      "#fff7fb","#ece2f0","#d0d1e6","#a6bddb","#67a9cf","#3690c0","#02818a","#016c59","#014636",
                      "#fff7fb","#ece7f2","#d0d1e6","#a6bddb","#74a9cf","#3690c0","#0570b0"];
        
        function draw(data) {
            d3.select("#container") // this selects the div with id='container'
                .append("h1")
                .text("Borrower APR by Occupation and Income Level, using D3")
                .attr("class", "drawtitle");
        
            // Create svg variable to use with D3 code 
            var svg = d3.select("#container")
                .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .attr("class", "svg");
            
            // Create myChart variable within the svg item to house the chart. 'g' is just an arbitrary containing child element in SVG
            // equivalent to 'div' in HTML
            var myChart = svg.append("g")
                .attr("transform","translate(" + margin.left +"," + margin.top +")")
                .attr("width", width)
                .attr("class", "chart");
                
            function plot_points(data) {
                // Extract the roll-up function from the nested function
                function agg_occupation(leaves) {
                    var meanApr = d3.mean(leaves, function(d){
                        return d['apr'];
                        })
                        return {"meanApr": meanApr,
                                "count": leaves.length};
                }
                
                // nest the data by Occupation Group then by Income Range
                var nested = d3.nest()
                    .key(function(d) {
                        return d['OccGroup'];
                    }).sortKeys(d3.ascending)
                    .key(function(d){
                        return d['income'];
                    })
                    .rollup(agg_occupation)
                    .entries(data);
                
                var occGroupScale = d3.scale.ordinal()
                    .domain(nested.keys)
                    .range(colors);
                
                // this function extracts the maximum meanAPR from a nested item - the lowest level
                // you then need to iterate over the nested[i].values
                function maxApr(nested_item) {
                    return d3.max(nested_item, function(d) {
                        return d.values.meanApr})
                }
                
                // this then returns the maximum of the maximum meanAPRs
                function maxAprGroup(double_nest) {
                    return d3.max(double_nest, function(d){
                        return maxApr(d.values);})
                }
                
                // do the same for the count
                function maxCount(nested_item) {
                    return d3.max(nested_item, function(d) {
                        return d.values.count})
                }
                
                // this then returns the maximum of the maximum meanAPRs
                function maxCountGroup(double_nest) {
                    return d3.max(double_nest, function(d){
                        return maxCount(d.values);})
                }
                
                var radiusScale = d3.scale.sqrt()
                    .domain([0, maxCountGroup(nested)])
                    .range([3,20])
                
                //Construct the  y axis - first find the extent of the data range for y values
                var yScale = d3.scale.linear()
                    .domain([0,maxAprGroup(nested)])
                    .range([height,0])
                    .nice();
                
                // create the y-axis object (note - not added yet, just defined)
                var yAxis = d3.svg.axis()
                    .scale(yScale)
                    .tickSize(5)
                    .tickFormat(formatAsPercentage)
                    .orient("left") // this specifies the orientation of labels to the axis
                    .innerTickSize(legendBuffer-width);
                
                // the x axis is categorical, so we need an ordinal scale. Check out padding if the data is too close to edges  
                var xScale = d3.scale.ordinal()
                    .domain(["$1-25k", "$25-50k", "$50-75k", "$75-100k", "$100k+"])
                    .rangePoints([0,width - legendBuffer],1);
                
                // create the x-axis object (note - not added yet, just defined)
                var xAxis = d3.svg.axis()
                    .scale(xScale)
                    .tickSize(5)
                    .orient("bottom");   // this specifies the orientation of labels to the axis
                    
                // Add the x-axis in it's own 'g' group.    
                myChart.append("g")
                    .attr("transform","translate(0," + height + ")")
                    .attr("class","x axis")
                    .call(xAxis)
                    .append('text')
                        .attr("x", width - legendBuffer)
                        .attr("y", -6)
                        .style("text-anchor","end")
                        .text("Income Bracket");
            
                // Add the y-axis in it's own 'g' group.
                myChart.append("g")
                    .attr("class","y axis")
                    .call(yAxis)
                    .append('text')
                        .attr('transform', "rotate(-90)")
                        .attr('y', 6)
                        .attr('dy', ".71em")
                        .style('text-anchor','end')
                        .style('fill','black')
                        .text('Average Borrower APR');
                        
                // add the tooltip area to the webpage
                var tooltip = d3.select("#container")
                    .append("div")
                        .attr("class", "tooltip")
                        .style("width", "150px")
                        .style("opacity", 0);
                
                // need to work on the circles code to work with the nested data        
                var circles = d3.select(".svg")
                    .selectAll("g")
                    .data(nested)
                            .enter()
                        .append('g')
                            .attr('class','circleG')
                    .selectAll('.circleG')
                    .data(function(d){
                        return d.values;
                    })
                        .enter()
                        .append('circle')
                            .attr('class', 'drawcircle')
                            .attr('cx', function(d) {
                                    return xScale(d.key) + margin.left;
                                    })
                            .attr('cy', function(d) {
                                    return yScale(d.values.meanApr);
                                    })
                            .attr("r", function(d) {
                                    return radiusScale(d.values.count);
                                    })
                            .style("opacity", 0.5)
                    .selectAll('.drawcircle')
                        .style('fill','red');
                    debugger;
                    
                    // NEED to work on this - how to color circles by their occupation
                    /*
                    var circles3 = d3.selectAll('.drawcircle')
                        .data(nested)
                            .enter()
                        .style('fill',function(d) {
                            return "red";
                            });
                      */
                        
            // draw legend
            var legend = d3.select('.svg')
                .selectAll(".legend")
                .data(nested)
                    .enter()
                .append("g")
                    .attr("class", "legend")
                    .attr("transform", function(d, i) { return "translate(0," + i * 9 +")"; });
            
            // draw legend colored rectangles - note this could have been chained to the above
            legend.append("rect")
                .attr("class", "drawLegendBox")
                .attr("x", width - 48)
                .attr("y", 2)
                .attr("width", 24)
                .attr("height", 6)
                .style("fill", function(d) {
                    return occGroupScale(d.key);
                    });
  
            };// END of function plot points(data)
        
        plot_points(data);
        
        };// END of function draw(data
        
        
      </script>
</head>
<body>
    <div id="container">
        <h1>Udacity Data Analysis Nano Degree</h1>
        <h2>Project 6: Make Effective Data Visualization</h2>
        <h2>Author: Doug Wight</h2>
        <h3>Submission date: February 2016</h3>
    </div>
    
    <script type="text/javascript">
    /*
    Use D3 to load the CSV file
    and pass the contents of it to the create function
    */
    d3.csv("data/loans_simple.csv", draw);

    
    </script>
</body>
</html>
